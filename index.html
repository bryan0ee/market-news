<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Market‑Moving News</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Bilingual (EN/KR) market-moving news summaries with impact calls and affected tickers." />
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-bold">Market‑Moving News Dashboard</h1>
      <div class="flex gap-2 items-center">
        <label class="text-sm">Language</label>
        <select id="lang" class="border rounded-lg px-2 py-1 text-sm">
          <option value="bilingual">Bilingual</option>
          <option value="en">English</option>
          <option value="ko">한국어</option>
        </select>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <section class="mb-4 grid gap-3 md:grid-cols-4">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">Search headlines</label>
        <input id="q" placeholder="Search… (e.g., CPI, tariffs, NVDA)" class="w-full border rounded-xl px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Impact</label>
        <select id="impact" class="w-full border rounded-xl px-3 py-2">
          <option value="">All</option>
          <option value="Bullish">Bullish</option>
          <option value="Bearish">Bearish</option>
          <option value="Neutral">Neutral</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Min confidence</label>
        <input id="conf" type="number" min="1" max="5" step="1" value="1" class="w-full border rounded-xl px-3 py-2" />
      </div>
    </section>

    <section class="mb-2">
      <div class="flex flex-wrap gap-2 text-sm" id="tickerChips"></div>
    </section>

    <section class="mb-4 flex items-center justify-between text-sm text-slate-600">
      <div>
        <span>Last updated: <span id="lastUpdated">—</span></span>
        <span class="ml-4" id="resultCount"></span>
      </div>
      <button id="refresh" class="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">Refresh</button>
    </section>

    <!-- Top Pagination -->
    <section id="topPagination" class="mb-4"></section>

    <section id="list" class="grid gap-3"></section>

    <!-- Bottom Pagination -->
    <section id="bottomPagination" class="mt-6"></section>

    <footer class="mt-10 py-8 text-center text-xs text-slate-500">
      Built for fast daily review • Bilingual summaries • Filter by impact/tickers • Paged results
    </footer>
  </main>

  <script>
    // --- Configuration ---
    const WATCHLIST = [
      'NVDA','GOOGL','MSFT','ORCL','CSCO','AMD','SNOW','META','CRWD',
      'DUK','WM','NEE','ED','RSG','COST','PG'
    ];

    // Pagination config
    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;
    let totalFilteredItems = 0;

    // Try to fetch data.json from the same folder. If missing, fall back to inline sample
    async function loadData() {
      try {
        const res = await fetch('data.json?_=' + Date.now());
        if (!res.ok) throw new Error('data.json not found');
        return await res.json();
      } catch (e) {
        console.warn('Using inline sample because data.json is missing:', e.message);
        return {
          last_updated: new Date().toISOString(),
          items: generateSampleData()
        };
      }
    }

    // Generate more sample data for pagination testing
    function generateSampleData() {
      const samples = [];
      const headlines = [
        'Fed official signals patience on rate cuts',
        'Large cap AI guides higher, hyperscaler capex intact',
        'Tech earnings beat expectations across the board',
        'Energy sector rallies on supply concerns',
        'Retail sales data shows consumer resilience',
        'Manufacturing PMI indicates expansion',
        'Labor market remains tight despite rate hikes',
        'Inflation data comes in below expectations',
        'Dollar strengthens against major currencies',
        'Bond yields rise on economic optimism',
        'Oil prices surge on geopolitical tensions',
        'Crypto market shows renewed interest',
        'Healthcare stocks gain on regulatory clarity',
        'Banking sector faces headwinds from rates',
        'Semiconductor demand remains robust'
      ];

      const impacts = ['Bullish', 'Bearish', 'Neutral'];
      const tickers = ['NVDA','GOOGL','MSFT','ORCL','CSCO','AMD','SNOW','META','CRWD','DUK','WM','NEE','ED','RSG','COST','PG'];

      for (let i = 0; i < 25; i++) {
        const impact = impacts[Math.floor(Math.random() * impacts.length)];
        const affectedTickers = tickers.slice(0, Math.floor(Math.random() * 5) + 2);
        
        samples.push({
          ts: new Date(Date.now() - Math.random() * 86400000 * 7).toISOString(),
          headline: `Sample ${i + 1}: ${headlines[i % headlines.length]}`,
          url: '#',
          impact: impact,
          confidence: Math.floor(Math.random() * 5) + 1,
          affected: affectedTickers,
          summary_en: `Market analysis shows ${impact.toLowerCase()} sentiment. Key factors include regulatory changes and earnings performance.`,
          summary_ko: `시장 분석에 따르면 ${impact === 'Bullish' ? '강세' : impact === 'Bearish' ? '약세' : '중립'} 심리를 보이고 있습니다. 주요 요인은 규제 변화와 실적입니다.`,
          next_en: `Watch for next earnings report and economic indicators.`,
          next_ko: `다음 실적 발표와 경제 지표를 주목하세요.`
        });
      }

      return samples.sort((a, b) => new Date(b.ts) - new Date(a.ts));
    }

    const state = {
      data: { last_updated: null, items: [] },
      query: '',
      impact: '',
      minConf: 1,
      tickers: new Set(),
      lang: 'bilingual'
    };

    function chipHTML(t, selected) {
      return `<button data-ticker="${t}" class="px-2.5 py-1 rounded-full border ${selected? 'bg-slate-900 text-white' : 'bg-white hover:bg-slate-50'}">${t}</button>`;
    }

    function impactBadge(impact) {
      const map = { 
        Bullish: 'bg-green-100 text-green-800 border-green-200', 
        Bearish: 'bg-red-100 text-red-800 border-red-200', 
        Neutral: 'bg-amber-100 text-amber-800 border-amber-200' 
      };
      return `<span class="text-xs px-2 py-0.5 rounded-full border ${map[impact]||'bg-slate-100 text-slate-700 border-slate-200'}">${impact}</span>`;
    }

    function createPaginationHTML(totalPages, currentPage) {
      if (totalPages <= 1) return '';

      let html = '<div class="flex flex-wrap justify-center items-center gap-2">';
      
      // Previous button
      if (currentPage > 1) {
        html += `<button class="px-3 py-2 rounded border bg-white hover:bg-slate-50" data-page="${currentPage - 1}">‹ Previous</button>`;
      }

      // Page numbers with smart truncation
      const showPages = [];
      
      // Always show first page
      if (totalPages > 1) showPages.push(1);
      
      // Show pages around current page
      for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
        if (!showPages.includes(i)) showPages.push(i);
      }
      
      // Always show last page
      if (totalPages > 1 && !showPages.includes(totalPages)) showPages.push(totalPages);

      // Add ellipsis and render pages
      let lastPage = 0;
      showPages.forEach(page => {
        if (page - lastPage > 1) {
          html += '<span class="px-2 text-slate-500">…</span>';
        }
        
        const isActive = page === currentPage;
        html += `<button class="px-3 py-2 rounded ${isActive ? 'bg-slate-900 text-white' : 'bg-white border hover:bg-slate-50'}" data-page="${page}">${page}</button>`;
        lastPage = page;
      });

      // Next button
      if (currentPage < totalPages) {
        html += `<button class="px-3 py-2 rounded border bg-white hover:bg-slate-50" data-page="${currentPage + 1}">Next ›</button>`;
      }

      html += '</div>';
      return html;
    }

    function attachPaginationListeners(container) {
      container.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-page]');
        if (!btn) return;
        
        const newPage = parseInt(btn.dataset.page);
        if (newPage !== currentPage) {
          currentPage = newPage;
          render();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    function render() {
      // Render chips
      const chipContainer = document.getElementById('tickerChips');
      chipContainer.innerHTML = WATCHLIST.map(t => chipHTML(t, state.tickers.has(t))).join('');

      // Filter items
      const q = state.query.toLowerCase();
      const filteredItems = state.data.items.filter(x => {
        const matchesQ = !q || x.headline.toLowerCase().includes(q) || (x.summary_en + (x.summary_ko || '')).toLowerCase().includes(q);
        const matchesImpact = !state.impact || x.impact === state.impact;
        const matchesConf = (x.confidence||1) >= state.minConf;
        const matchesTicker = state.tickers.size === 0 || x.affected?.some(t => state.tickers.has(t));
        return matchesQ && matchesImpact && matchesConf && matchesTicker;
      });

      totalFilteredItems = filteredItems.length;

      // Update result count
      const resultCount = document.getElementById('resultCount');
      resultCount.textContent = `Showing ${totalFilteredItems} result${totalFilteredItems !== 1 ? 's' : ''}`;

      // Pagination logic
      const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE) || 1;
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const pageItems = filteredItems.slice(start, start + ITEMS_PER_PAGE);

      // Render pagination (top and bottom)
      const paginationHTML = createPaginationHTML(totalPages, currentPage);
      const topPagination = document.getElementById('topPagination');
      const bottomPagination = document.getElementById('bottomPagination');
      
      topPagination.innerHTML = paginationHTML;
      bottomPagination.innerHTML = paginationHTML;
      
      // Attach event listeners to both pagination sections
      attachPaginationListeners(topPagination);
      attachPaginationListeners(bottomPagination);

      // Render items
      const list = document.getElementById('list');
      if (!pageItems.length) {
        list.innerHTML = `<div class="p-6 bg-white rounded-2xl border text-slate-600">No items match your filters.</div>`;
      } else {
        list.innerHTML = pageItems.map((x, index) => `
          <article class="p-4 md:p-5 bg-white rounded-2xl border">
            <div class="flex flex-wrap items-center gap-2 justify-between">
              <a href="${x.url}" target="_blank" class="font-semibold hover:underline">${x.headline}</a>
              <div class="flex items-center gap-2">
                ${impactBadge(x.impact)}
                <span class="text-xs text-slate-500">Conf: ${x.confidence||1}/5</span>
                <span class="text-xs text-slate-400">#${start + index + 1}</span>
              </div>
            </div>
            <div class="mt-1 text-xs text-slate-500">${new Date(x.ts).toLocaleString()}</div>

            <div class="mt-3 space-y-2 text-sm">
              ${state.lang !== 'ko' ? `<p>${x.summary_en||''}</p>`:''}
              ${state.lang !== 'en' ? `<p class="text-slate-700">${x.summary_ko||''}</p>`:''}
            </div>

            <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
              <span class="text-slate-500">Affected:</span>
              ${(x.affected||[]).map(t=>`<span class="px-2 py-0.5 border rounded-full bg-slate-50">${t}</span>`).join('')}
            </div>

            <div class="mt-3 grid md:grid-cols-2 gap-2 text-xs">
              ${state.lang !== 'ko' ? `<div class="p-3 bg-slate-50 rounded-xl"><span class="font-medium">Next:</span> ${x.next_en||''}</div>`:''}
              ${state.lang !== 'en' ? `<div class="p-3 bg-slate-50 rounded-xl"><span class="font-medium">다음:</span> ${x.next_ko||''}</div>`:''}
            </div>
          </article>
        `).join('');
      }

      // Update last updated timestamp
      document.getElementById('lastUpdated').textContent = state.data.last_updated ? new Date(state.data.last_updated).toLocaleString() : '—';
    }

    // Event wiring
    document.getElementById('q').addEventListener('input', (e)=>{ currentPage = 1; state.query = e.target.value; render(); });
    document.getElementById('impact').addEventListener('change', (e)=>{ currentPage = 1; state.impact = e.target.value; render(); });
    document.getElementById('conf').addEventListener('input', (e)=>{ currentPage = 1; state.minConf = Number(e.target.value)||1; render(); });
    document.getElementById('lang').addEventListener('change', (e)=>{ state.lang = e.target.value; render(); });

    document.getElementById('tickerChips').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-ticker]');
      if (!btn) return;
      const t = btn.dataset.ticker;
      if (state.tickers.has(t)) state.tickers.delete(t); else state.tickers.add(t);
      currentPage = 1;
      render();
    });

    document.getElementById('refresh').addEventListener('click', async ()=>{
      const refreshBtn = document.getElementById('refresh');
      refreshBtn.textContent = 'Loading...';
      refreshBtn.disabled = true;
      
      try {
        state.data = await loadData();
        currentPage = 1;
        render();
      } catch (error) {
        console.error('Failed to refresh data:', error);
      } finally {
        refreshBtn.textContent = 'Refresh';
        refreshBtn.disabled = false;
      }
    });

    // Init
    (async () => {
      state.data = await loadData();
      render();
    })();
  </script>
</body>
</html>
